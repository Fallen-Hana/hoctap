<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C·ªïng h·ªçc t·∫≠p l·ªõp ‚Ä¢ ƒêƒÉng nh·∫≠p tr∆∞·ªõc</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 via CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{background:#0f172a}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
    .card{border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .bubble{border-radius:14px;padding:10px 12px;max-width:80%;white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body class="text-slate-100">
  <!-- ================= CONFIG ================= -->
  <script>
    // üëâ ƒêi·ªÅn c√°c th√¥ng s·ªë c·ªßa b·∫°n
    const SUPABASE_URL  = "https://YOUR-PROJECT.supabase.co"; // v√≠ d·ª•: https://abcd.supabase.co
    const SUPABASE_ANON = "YOUR_ANON_KEY";                     // Anon key (public) t·ª´ Supabase
    const N8N_WEBHOOK_URL = "https://your-n8n-domain.com/webhook/class-chat"; // webhook n8n ƒë·ªÉ chat

    // T√™n l·ªõp & logo (tu·ª≥ ch·ªânh giao di·ªán)
    const CLASS_NAME = "L·ªõp 8A - C·ªïng h·ªçc t·∫≠p";
    const BRAND_TEXT = "8A2 Tr·∫ßn Ph√∫";
  </script>

  <!-- ================ AUTH SCREEN (first) ================= -->
  <section id="auth-screen" class="min-h-screen grid place-items-center px-4">
    <div class="glass card w-full max-w-xl p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-lg bg-emerald-400"></div>
          <h1 class="text-xl font-semibold">{{BRAND}}</h1>
        </div>
        <span class="text-sm text-slate-300">Ch·ªâ d√†nh cho h·ªçc sinh trong l·ªõp</span>
      </div>

      <!-- LOGIN by code ONLY -->
      <div class="glass p-5 rounded-xl">
        <h2 class="text-lg font-semibold mb-2">ƒêƒÉng nh·∫≠p b·∫±ng m√£ h·ªçc sinh</h2>
        <p class="text-slate-300 text-sm mb-4">
          M·ªói b·∫°n c√≥ m·ªôt <b>m√£ ƒëƒÉng nh·∫≠p</b> (v√≠ d·ª•: STU01). Nh·∫≠p ƒë√∫ng m√£ ƒë·ªÉ v√†o l·ªõp.
        </p>
        <label class="block text-sm mb-1">M√£ h·ªçc sinh</label>
        <input id="login-code"
               class="w-full rounded-lg bg-slate-900/50 border border-slate-700 px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-emerald-400"
               placeholder="VD: STU01" />
        <button id="btn-login-code"
                class="w-full bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-3 py-2">
          V√†o l·ªõp
        </button>
        <p id="login-code-msg" class="mt-2 text-sm text-rose-400"></p>
        <hr class="my-4 border-slate-700">
        <p class="text-xs text-slate-400">
          * D·ªØ li·ªáu ƒëƒÉng nh·∫≠p l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát; d√πng <b>ƒêƒÉng xu·∫•t</b> ƒë·ªÉ ƒë·ªïi t√†i kho·∫£n.
        </p>
      </div>
    </div>
  </section>

  <!-- ================ APP SCREEN (after login) ================= -->
  <section id="app-screen" class="hidden min-h-screen">
    <header class="glass card mx-auto max-w-6xl mt-6 p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded bg-emerald-400"></div>
        <div>
          <h2 class="font-semibold">{{CLASS_NAME}}</h2>
          <p class="text-xs text-slate-300">Xin ch√†o, <span id="student-name" class="font-medium text-slate-100"></span> ‚Ä¢ M√£: <span id="student-code" class="text-slate-300"></span></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-view-scores" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-600 text-sm">B·∫£ng ƒëi·ªÉm</button>
        <button id="btn-logout" class="px-3 py-1.5 rounded-lg bg-rose-500 hover:bg-rose-600 text-white text-sm">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main class="mx-auto max-w-6xl p-4 grid md:grid-cols-3 gap-4">
      <aside class="glass card p-4 md:col-span-1">
        <h3 class="font-semibold mb-3">T·ªïng quan</h3>
        <ul class="text-sm text-slate-300 list-disc ml-5 space-y-1">
          <li>Chat AI ƒë·ªÉ h·ªèi b√†i</li>
          <li>L√†m b√†i tr·∫Øc nghi·ªám (ƒëang c·∫≠p nh·∫≠t)</li>
          <li>ƒêi·ªÉm & l·ªãch s·ª≠ h·ªçc s·∫Ω l∆∞u ·ªü CSDL</li>
        </ul>
        <div class="mt-4 text-xs text-slate-400">D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n Supabase; ch·ªâ b·∫°n v√† gi√°o vi√™n xem ƒë∆∞·ª£c ƒëi·ªÉm c·ªßa b·∫°n.</div>
      </aside>

      <!-- Right: Chat panel -->
      <section class="glass card p-0 md:col-span-2 flex flex-col">
        <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between">
          <h3 class="font-semibold">Chat AI ‚Ä¢ H·ªó tr·ª£ h·ªçc t·∫≠p</h3>
          <span id="chat-status" class="text-xs text-emerald-300">ƒêang s·∫µn s√†ng</span>
        </div>
        <div id="chat-log" class="flex-1 overflow-y-auto p-4 space-y-2">
          <div class="bubble bg-slate-800 text-slate-100">Xin ch√†o! H√£y ƒë·∫∑t c√¢u h·ªèi. V√≠ d·ª•: "Gi·∫£i ph∆∞∆°ng tr√¨nh b·∫≠c hai?"</div>
        </div>
        <div class="p-3 border-t border-slate-700 flex gap-2">
          <input id="chat-input" class="flex-1 rounded-lg bg-slate-900/60 border border-slate-700 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
          <button id="chat-send" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white">G·ª≠i</button>
        </div>
      </section>
    </main>

    <!-- Scores modal -->
    <div id="scores-modal" class="hidden fixed inset-0 bg-black/60 grid place-items-center p-4">
      <div class="glass card max-w-2xl w-full p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">B·∫£ng ƒëi·ªÉm c·ªßa b·∫°n</h3>
          <button id="scores-close" class="text-sm px-2 py-1 rounded bg-slate-800">ƒê√≥ng</button>
        </div>
        <table id="scores-table" class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-300">
              <th class="py-2">M√¥n</th>
              <th class="py-2">B√†i / M√£</th>
              <th class="py-2">ƒêi·ªÉm</th>
              <th class="py-2">C·∫≠p nh·∫≠t</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-700"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================ APP LOGIC ================= -->
  <script>
    const $ = (q)=>document.querySelector(q);

    // Inject brand/class name
    document.body.innerHTML = document.body.innerHTML
      .replaceAll("{{BRAND}}", BRAND_TEXT)
      .replaceAll("{{CLASS_NAME}}", CLASS_NAME);

    // Supabase client
    const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON);

    // Helpers
    const state = { student: null };
    const saveSession = (s)=>localStorage.setItem('student', JSON.stringify(s));
    const loadSession = ()=>{ try{return JSON.parse(localStorage.getItem('student')||'null');}catch(e){return null;} };
    const clearSession = ()=>localStorage.removeItem('student');

    function show(section){
      $('#auth-screen').classList.toggle('hidden', section!=='auth');
      $('#app-screen').classList.toggle('hidden', section!=='app');
    }
    function setStudentUI(){
      $('#student-name').textContent = state.student?.name || '';
      $('#student-code').textContent = state.student?.login_code || '';
    }

    // ---------- AUTH: login by code ----------
    async function loginByCode(){
      const code = $('#login-code').value.trim();
      const msg = $('#login-code-msg'); msg.textContent='';
      if(!code){ msg.textContent='Nh·∫≠p m√£ h·ªçc sinh.'; return; }

      const { data, error } = await supabase
        .from('students').select('*')
        .eq('login_code', code).limit(1).maybeSingle();

      if(error){ msg.textContent='L·ªói k·∫øt n·ªëi CSDL.'; return; }
      if(!data){ msg.textContent='M√£ kh√¥ng ƒë√∫ng.'; return; }

      state.student = data; saveSession(data);
      setStudentUI(); show('app');
    }

    // ---------- CHAT ----------
    function addBubble(role, text){
      const el = document.createElement('div');
      el.className = `bubble ${role==='user'?'bg-emerald-600/90':'bg-slate-800'} text-slate-100`;
      el.textContent = text;
      $('#chat-log').appendChild(el);
      $('#chat-log').scrollTop = $('#chat-log').scrollHeight;
    }

    async function sendChat(){
      const inp = $('#chat-input'); const text = inp.value.trim(); if(!text) return; inp.value='';
      addBubble('user', text);
      $('#chat-status').textContent = 'ƒêang g·ª≠i...';
      try{
        const res = await fetch(N8N_WEBHOOK_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            student_id: state.student.id,
            login_code: state.student.login_code,
            name: state.student.name,
            message: text
          })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        addBubble('assistant', data.reply || 'Kh√¥ng c√≥ ph·∫£n h·ªìi.');
      }catch(e){
        addBubble('assistant', '‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.');
      }finally{
        $('#chat-status').textContent='ƒêang s·∫µn s√†ng';
      }
    }

    // ---------- SCORES ----------
    async function openScores(){
      document.getElementById('scores-modal').classList.remove('hidden');
      const tbody = document.querySelector('#scores-table tbody'); tbody.innerHTML = '';
      const { data, error } = await supabase
        .from('scores')
        .select('subject, test_id, score, updated_at')
        .eq('student_id', state.student.id)
        .order('updated_at', { ascending:false });
      if(error){ tbody.innerHTML = `<tr><td colspan=4 class="py-3 text-rose-400">Kh√¥ng t·∫£i ƒë∆∞·ª£c b·∫£ng ƒëi·ªÉm.</td></tr>`; return; }
      if(!data?.length){ tbody.innerHTML = `<tr><td colspan=4 class="py-3 text-slate-300">Ch∆∞a c√≥ ƒëi·ªÉm.</td></tr>`; return; }
      for(const r of data){
        const tr = document.createElement('tr'); tr.className='text-slate-200';
        tr.innerHTML = `<td class="py-2">${r.subject||''}</td><td>${r.test_id||''}</td><td>${r.score??''}</td><td>${new Date(r.updated_at).toLocaleString('vi-VN')}</td>`;
        tbody.appendChild(tr);
      }
    }

    // ---------- EVENTS ----------
    document.getElementById('btn-login-code').addEventListener('click', loginByCode);
    document.getElementById('btn-logout').addEventListener('click', ()=>{ clearSession(); location.reload(); });
    document.getElementById('chat-send').addEventListener('click', sendChat);
    document.getElementById('chat-input').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });
    document.getElementById('btn-view-scores').addEventListener('click', openScores);
    document.getElementById('scores-close').addEventListener('click', ()=>document.getElementById('scores-modal').classList.add('hidden'));

    // ---------- INIT ----------
    (function init(){
      const s = loadSession();
      if(s && s.id){ state.student = s; setStudentUI(); show('app'); }
      else { show('auth'); }
    })();
  </script>
</body>
</html>
