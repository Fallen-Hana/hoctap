<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Đăng nhập lớp học (DEBUG)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 1) Nạp SDK Supabase. Dùng defer để đảm bảo nó tải trước khi script dưới chạy -->
  <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>

  <style>
    body{background:#0d1117}
    .card{background:#161b22;border:1px solid #30363d;border-radius:14px}
    .hint{color:#8b949e}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center text-white">
  <div class="card w-[380px] p-6 shadow-xl">
    <div class="flex items-center mb-3">
      <div class="w-3.5 h-3.5 rounded-sm bg-emerald-400 mr-2"></div>
      <h1 class="text-lg font-semibold">8A2 Trần Phú</h1>
      <span class="ml-auto hint text-xs">DEBUG build</span>
    </div>

    <label class="block text-sm mb-2">Mã học sinh</label>
    <input id="login_code" type="text" placeholder="VD: A2-14"
           class="w-full p-2 rounded bg-[#0d1117] border border-gray-600 focus:ring-2 focus:ring-emerald-500 outline-none" />

    <button id="btnLogin" class="mt-4 w-full py-2 rounded bg-emerald-500 hover:bg-emerald-600 text-black font-medium">
      Vào lớp
    </button>

    <p id="msg" class="h-6 mt-3 text-sm text-red-400"></p>
    <p class="hint text-xs mt-4">* Chạy bằng http://localhost, không chạy file://</p>
  </div>

  <!-- 2) Script chính (debug từng bước) -->
  <script type="module">
    // ======= CONFIG — THAY BẰNG THÔNG SỐ THẬT CỦA BẠN =======
    const SB_URL  = "https://hvokqjjacpvorkszddqf.supabase.co";   // <-- thay
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2b2txamphY3B2b3Jrc3pkZHFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjI5ODUsImV4cCI6MjA3NzczODk4NX0.P9BcwbKCIwya03BOQbGcLbdGQ6UKEL5o_sIE6qeQS7A";               // <-- thay
    // ========================================================

    // Bẫy mọi lỗi rơi tự do để thấy ngay trên console
    window.onerror = (m, src, line, col, err) => {
      console.error("[window.onerror]", { m, src, line, col, err });
      setMsg("Lỗi JS: " + m);
    };
    window.onunhandledrejection = (evt) => {
      console.error("[unhandledrejection]", evt.reason);
      setMsg("Lỗi Promise: " + (evt.reason?.message || evt.reason));
    };

    const msgEl = document.getElementById('msg');
    const input = document.getElementById('login_code');
    const btn   = document.getElementById('btnLogin');

    function setMsg(t){ msgEl.textContent = t || ""; }

    console.groupCollapsed("BOOT");
    console.log("[1] Location:", window.location.href);
    console.log("[2] Protocol should be http(s)://, got:", window.location.protocol);
    console.log("[3] Supabase SDK loaded? ->", !!window.supabase);
    if (!window.supabase) {
      console.warn("SDK chưa có. Có thể đang mở file:// hoặc CDN bị chặn.");
      setMsg("Không tải được Supabase SDK.");
    }
    console.groupEnd();

    // Chặn click trước khi createClient xong
    btn.disabled = true;

    // Đợi DOM & SDK sẵn sàng
    document.addEventListener('DOMContentLoaded', async () => {
      console.group("INIT");
      try {
        // 4) Tạo client — KHÔNG đặt tên 'supabase' để tránh đè biến global
        console.log("[4] Creating client with URL:", SB_URL.slice(0, 35) + "...");
        const sb = window.supabase?.createClient?.(SB_URL, SB_ANON);
        console.log("[5] Client created? ->", !!sb);

        if (!sb) {
          setMsg("Không tạo được client Supabase (kiểm tra SDK/URL/key).");
          console.groupEnd();
          return;
        }

        // 5) Thử ping bảng công khai (không bắt buộc) — kiểm tra nhanh kết nối
        console.log("[6] Quick connectivity check (no-op RPC)...");
        // Không có endpoint health chính thức; bỏ qua bước này nếu RLS chặn.

        // 6) Gắn handler click
        btn.disabled = false;
        btn.addEventListener('click', async () => {
          console.group("LOGIN_CLICK");
          setMsg("");
          const code = (input.value || "").trim();
          console.log("[7] Clicked. Code =", code ? code : "(empty)");

          if (!code) {
            console.warn("[8] Empty code -> show UI error");
            setMsg("⚠️ Vui lòng nhập mã học sinh.");
            console.groupEnd();
            return;
          }

          try {
            btn.disabled = true; btn.textContent = "Đang kiểm tra...";
            console.log("[9] Query Supabase: students WHERE login_code =", code);

            const { data, error } = await sb
              .from("students")
              .select("id, name, login_code")
              .eq("login_code", code)
              .maybeSingle();

            console.log("[10] Supabase response:", { data, error });

            if (error) {
              console.error("[11] Supabase error:", error);
              setMsg("Lỗi Supabase: " + (error.message || "Xem Console"));
              return;
            }

            if (!data) {
              console.warn("[12] No student found for code:", code);
              setMsg("❌ Mã học sinh không đúng.");
              return;
            }

            console.log("[13] Login OK. Student =", data);
            localStorage.setItem("student", JSON.stringify(data));

            // 7) Chuyển trang — tạm thời chuyển tới dummy trang nếu bạn chưa có chat.html
            const next = "chat.html";
            console.log("[14] Redirect to:", next);
            window.location.href = next; // Đảm bảo file chat.html tồn tại
          } catch (err) {
            console.error("[15] Exception during login:", err);
            setMsg("Lỗi không xác định. Xem Console.");
          } finally {
            btn.disabled = false; btn.textContent = "Vào lớp";
            console.groupEnd();
          }
        });
      } catch (e) {
        console.error("[INIT ERROR]", e);
        setMsg("Init lỗi: " + (e.message || e));
      }
      console.groupEnd();
    });
  </script>
</body>
</html>
